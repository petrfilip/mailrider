<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catch-all Mail Server - Professional Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f4ff',
                            100: '#e0e9ff',
                            500: '#667eea',
                            600: '#5568d3',
                            700: '#4451b2',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-200">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-10">
            <div class="px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <svg class="w-8 h-8 text-primary-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                        </svg>
                        <div>
                            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Catch-all Mail Server</h1>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Receives ALL emails to any address and domain</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <!-- Stats -->
                        <div class="hidden md:flex items-center space-x-4 text-sm">
                            <div class="text-center px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded">
                                <div class="font-bold text-primary-600 dark:text-primary-400" id="headerTotalEmails">0</div>
                                <div class="text-xs text-gray-600 dark:text-gray-400">Emails</div>
                            </div>
                            <div class="text-center px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded">
                                <div class="font-bold text-primary-600 dark:text-primary-400" id="headerTotalSize">0 B</div>
                                <div class="text-xs text-gray-600 dark:text-gray-400">Size</div>
                            </div>
                        </div>
                        <!-- Dark mode toggle -->
                        <button onclick="toggleDarkMode()" class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                            <svg class="w-5 h-5 text-gray-700 dark:text-gray-300 hidden dark:block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                            </svg>
                            <svg class="w-5 h-5 text-gray-700 dark:text-gray-300 block dark:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                            </svg>
                        </button>
                        <!-- Import EML button -->
                        <button onclick="openImportModal()" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors flex items-center space-x-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                            <span>Import EML</span>
                        </button>
                        <!-- Manage Folders button -->
                        <button onclick="openFoldersModal()" class="px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg transition-colors flex items-center space-x-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
                            </svg>
                            <span>Folders</span>
                        </button>
                        <!-- Refresh button -->
                        <button onclick="loadEmails()" id="refreshBtn" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg transition-colors flex items-center space-x-2">
                            <svg class="w-4 h-4" id="refreshIcon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            <span>Refresh</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-0 h-[calc(100vh-88px)]">
            <!-- Left Panel - Email List (25%) -->
            <div class="lg:col-span-3 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex flex-col min-w-[320px]">
                <!-- Search & Toolbar -->
                <div class="p-4 border-b border-gray-200 dark:border-gray-700 space-y-3">
                    <!-- Search -->
                    <div class="relative">
                        <input
                            type="text"
                            id="searchInput"
                            placeholder="Search emails..."
                            onkeyup="debouncedSearch()"
                            class="w-full px-4 py-2 pl-10 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400"
                        >
                        <svg class="w-5 h-5 text-gray-400 absolute left-3 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>

                    <!-- Folder Filter -->
                    <div class="relative">
                        <select
                            id="folderFilter"
                            onchange="filterEmails()"
                            class="w-full px-4 py-2 pl-10 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent text-gray-900 dark:text-white appearance-none cursor-pointer"
                        >
                            <option value="">All folders</option>
                        </select>
                        <svg class="w-5 h-5 text-gray-400 absolute left-3 top-2.5 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
                        </svg>
                        <svg class="w-4 h-4 text-gray-400 absolute right-3 top-3 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>

                    <!-- Bulk Actions -->
                    <div class="flex items-center justify-between">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" class="w-4 h-4 text-primary-500 bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded focus:ring-primary-500">
                            <span class="text-sm text-gray-700 dark:text-gray-300">Select all</span>
                        </label>
                        <div class="flex space-x-2">
                            <button onclick="deleteSelected()" class="px-3 py-1 text-sm bg-red-500 hover:bg-red-600 text-white rounded transition-colors">
                                Delete selected
                            </button>
                            <button onclick="deleteAll()" class="px-3 py-1 text-sm bg-red-600 hover:bg-red-700 text-white rounded transition-colors">
                                Delete all
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Email List -->
                <div id="emailList" class="flex-1 overflow-y-auto">
                    <div class="p-4 text-center text-gray-500 dark:text-gray-400">
                        Loading...
                    </div>
                </div>
            </div>

            <!-- Right Panel - Email Detail (75%) -->
            <div class="lg:col-span-9 bg-white dark:bg-gray-800 flex flex-col">
                <div id="emailDetail" class="h-full flex items-center justify-center text-gray-500 dark:text-gray-400">
                    <div class="text-center">
                        <svg class="w-24 h-24 mx-auto mb-4 text-gray-300 dark:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                        </svg>
                        <p class="text-lg">Select an email to view details</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Import Modal -->
        <div id="importModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Import EML Files</h2>
                        <button onclick="closeImportModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- Drag & Drop Area -->
                    <div id="dropZone" class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-8 text-center hover:border-primary-500 dark:hover:border-primary-400 transition-colors cursor-pointer">
                        <input type="file" id="emlFileInput" accept=".eml,message/rfc822" multiple class="hidden" onchange="handleFileSelect(event)">
                        <svg class="w-16 h-16 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        <p class="text-lg font-medium text-gray-700 dark:text-gray-300 mb-2">Drag & drop EML files here</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">or</p>
                        <button onclick="document.getElementById('emlFileInput').click()" class="px-6 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg transition-colors">
                            Browse Files
                        </button>
                        <p class="text-xs text-gray-400 dark:text-gray-500 mt-4">You can select multiple files (max 50MB each)</p>
                    </div>

                    <!-- Selected Files List -->
                    <div id="selectedFilesList" class="mt-6 hidden">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">Selected Files</h3>
                        <div id="filesList" class="space-y-2 max-h-60 overflow-y-auto"></div>
                    </div>

                    <!-- Progress Bar -->
                    <div id="uploadProgress" class="mt-6 hidden">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Uploading...</span>
                            <span id="progressPercent" class="text-sm font-medium text-gray-700 dark:text-gray-300">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                            <div id="progressBar" class="bg-primary-500 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Import Results -->
                    <div id="importResults" class="mt-6 hidden">
                        <div id="resultsContent"></div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="mt-6 flex justify-end space-x-3">
                        <button onclick="closeImportModal()" class="px-6 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg transition-colors">
                            Cancel
                        </button>
                        <button id="importBtn" onclick="importFiles()" disabled class="px-6 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                            Import Files
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Folders Modal -->
        <div id="foldersModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Manage Folders</h2>
                        <button onclick="closeFoldersModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- Create New Folder -->
                    <div class="mb-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">Create New Folder</h3>
                        <div class="flex space-x-2">
                            <input
                                type="text"
                                id="newFolderName"
                                placeholder="Folder name..."
                                class="flex-1 px-4 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent text-gray-900 dark:text-white"
                            >
                            <button onclick="createFolder()" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors">
                                Create
                            </button>
                        </div>
                    </div>

                    <!-- Folders List -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">Existing Folders</h3>
                        <div id="foldersList" class="space-y-2">
                            <div class="p-4 text-center text-gray-500 dark:text-gray-400">
                                Loading folders...
                            </div>
                        </div>
                    </div>

                    <!-- Close Button -->
                    <div class="mt-6 flex justify-end">
                        <button onclick="closeFoldersModal()" class="px-6 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg transition-colors">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State management
        let allEmails = [];
        let filteredEmails = [];
        let selectedEmail = null;
        let selectedEmailFilename = null;
        let currentTab = 'html';
        let autoRefreshInterval = null;

        // Pagination state
        const PAGE_SIZE = 50;
        let currentOffset = 0;
        let hasMoreEmails = true;
        let isLoadingMore = false;
        let latestTimestamp = 0;
        let totalEmails = 0;
        let filteredTotal = 0;
        let searchDebounceTimer = null;

        // Dark mode
        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('darkMode', document.documentElement.classList.contains('dark'));
        }

        // Initialize dark mode from localStorage
        if (localStorage.getItem('darkMode') === 'true') {
            document.documentElement.classList.add('dark');
        }

        // Format utilities
        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'Nezn√°m√Ω';
            const date = new Date(timestamp * 1000);
            const now = new Date();
            const diff = now - date;

            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return Math.floor(diff / 60000) + ' min';
            if (diff < 86400000) return Math.floor(diff / 3600000) + ' h';

            return date.toLocaleString('en-US');
        }

        function truncate(str, length) {
            return str.length > length ? str.substring(0, length) + '...' : str;
        }

        // Build API URL with current filters
        function buildApiUrl(baseParams = {}) {
            const selectedFolder = document.getElementById('folderFilter').value;
            const searchTerm = document.getElementById('searchInput').value.trim();

            const params = new URLSearchParams(baseParams);
            if (selectedFolder) params.set('folder', selectedFolder);
            if (searchTerm) params.set('search', searchTerm);

            return `/api/emails?${params.toString()}`;
        }

        // Load emails list (initial load with pagination)
        async function loadEmails(reset = true) {
            const refreshBtn = document.getElementById('refreshBtn');
            const refreshIcon = document.getElementById('refreshIcon');

            refreshBtn.disabled = true;
            refreshIcon.classList.add('animate-spin');

            try {
                // Reset pagination state on fresh load
                if (reset) {
                    currentOffset = 0;
                    allEmails = [];
                    hasMoreEmails = true;
                }

                const url = buildApiUrl({ limit: PAGE_SIZE, offset: currentOffset });

                const response = await fetch(url);
                const data = await response.json();

                if (reset) {
                    allEmails = data.emails || [];
                } else {
                    allEmails = [...allEmails, ...(data.emails || [])];
                }

                hasMoreEmails = data.hasMore;
                latestTimestamp = data.latestTimestamp || 0;
                totalEmails = data.total;
                filteredTotal = data.filteredTotal || data.total;
                currentOffset = allEmails.length;

                // Update header stats
                document.getElementById('headerTotalEmails').textContent = data.total;
                document.getElementById('headerTotalSize').textContent = formatSize(data.totalSize);

                // Update folder filter dropdown (only on initial load without search)
                if (reset && !document.getElementById('searchInput').value.trim()) {
                    updateFolderFilter();
                }

                // Render the list (no client-side filtering needed - server handles it)
                renderEmailList();

                // Re-select if email still exists
                if (selectedEmailFilename) {
                    const stillExists = allEmails.find(e => e.filename === selectedEmailFilename);
                    if (!stillExists) {
                        // Email was deleted, clear selection
                        selectedEmailFilename = null;
                        selectedEmail = null;
                        renderEmailDetail();
                    }
                }
            } catch (error) {
                console.error('Failed to load emails:', error);
                document.getElementById('emailList').innerHTML = `
                    <div class="p-4 text-center text-red-500">
                        Error loading: ${error.message}
                    </div>
                `;
            } finally {
                refreshBtn.disabled = false;
                refreshIcon.classList.remove('animate-spin');
            }
        }

        // Load more emails (infinite scroll)
        async function loadMoreEmails() {
            if (isLoadingMore || !hasMoreEmails) return;

            isLoadingMore = true;
            showLoadingIndicator();

            try {
                const url = buildApiUrl({ limit: PAGE_SIZE, offset: currentOffset });

                const response = await fetch(url);
                const data = await response.json();

                const newEmails = data.emails || [];
                allEmails = [...allEmails, ...newEmails];
                hasMoreEmails = data.hasMore;
                currentOffset = allEmails.length;

                // Render the updated list
                renderEmailList();
            } catch (error) {
                console.error('Failed to load more emails:', error);
            } finally {
                isLoadingMore = false;
                hideLoadingIndicator();
            }
        }

        // Load new emails (auto-refresh - prepend new ones)
        async function loadNewEmails() {
            if (latestTimestamp === 0) return;

            try {
                const url = buildApiUrl({ since: latestTimestamp });

                const response = await fetch(url);
                const data = await response.json();

                const newEmails = data.emails || [];

                if (newEmails.length > 0) {
                    // Prepend new emails (they are newer)
                    allEmails = [...newEmails, ...allEmails];
                    latestTimestamp = data.latestTimestamp || latestTimestamp;
                    currentOffset += newEmails.length;

                    // Update header stats
                    document.getElementById('headerTotalEmails').textContent = data.total;
                    document.getElementById('headerTotalSize').textContent = formatSize(data.totalSize);

                    // Render the updated list
                    renderEmailList();
                }
            } catch (error) {
                console.error('Failed to check for new emails:', error);
            }
        }

        // Show loading indicator at bottom of list
        function showLoadingIndicator() {
            const emailList = document.getElementById('emailList');
            const loader = document.createElement('div');
            loader.id = 'loadMoreIndicator';
            loader.className = 'p-4 text-center text-gray-500 dark:text-gray-400';
            loader.innerHTML = `
                <svg class="animate-spin h-5 w-5 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            `;
            emailList.appendChild(loader);
        }

        function hideLoadingIndicator() {
            const loader = document.getElementById('loadMoreIndicator');
            if (loader) loader.remove();
        }

        // Update folder filter dropdown with available folders
        function updateFolderFilter() {
            const folderFilter = document.getElementById('folderFilter');
            const currentSelection = folderFilter.value;

            // Get unique folders from emails
            const folders = new Set();
            allEmails.forEach(email => {
                if (email.folder) {
                    folders.add(email.folder);
                }
            });

            // Sort folders (INBOX first, then alphabetically)
            const sortedFolders = Array.from(folders).sort((a, b) => {
                if (a === 'INBOX') return -1;
                if (b === 'INBOX') return 1;
                return a.localeCompare(b);
            });

            // Update dropdown options
            folderFilter.innerHTML = '<option value="">All folders</option>' +
                sortedFolders.map(folder =>
                    `<option value="${folder}">${folder}</option>`
                ).join('');

            // Restore previous selection if it still exists
            if (currentSelection && sortedFolders.includes(currentSelection)) {
                folderFilter.value = currentSelection;
            }
        }

        // Filter emails - triggers server-side reload with new filters
        function filterEmails() {
            // Reset and reload with current filter settings (server handles filtering)
            loadEmails(true);
        }

        // Debounced search - waits for user to stop typing
        function debouncedSearch() {
            if (searchDebounceTimer) {
                clearTimeout(searchDebounceTimer);
            }
            searchDebounceTimer = setTimeout(() => {
                filterEmails();
            }, 300); // 300ms delay
        }

        // Render email list
        function renderEmailList() {
            const emailList = document.getElementById('emailList');

            if (allEmails.length === 0) {
                emailList.innerHTML = `
                    <div class="p-8 text-center">
                        <svg class="w-16 h-16 mx-auto mb-4 text-gray-300 dark:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                        </svg>
                        <p class="text-gray-500 dark:text-gray-400">No emails</p>
                    </div>
                `;
                return;
            }

            emailList.innerHTML = allEmails.map(email => `
                <div
                    onclick="selectEmail('${email.filename}')"
                    class="email-item border-b border-gray-200 dark:border-gray-700 p-4 hover:bg-gray-50 dark:hover:bg-gray-750 cursor-pointer transition-colors ${selectedEmailFilename === email.filename ? 'bg-primary-50 dark:bg-primary-900/20 border-l-4 border-l-primary-500' : ''} ${!email.isRead ? 'bg-blue-50 dark:bg-blue-900/10' : ''}"
                >
                    <div class="flex items-start justify-between mb-2">
                        <input
                            type="checkbox"
                            class="email-checkbox mt-1 w-4 h-4 text-primary-500 bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded focus:ring-primary-500"
                            data-filename="${email.filename}"
                            onclick="event.stopPropagation()"
                        >
                        <div class="flex-1 ml-3">
                            <div class="flex items-center space-x-2">
                                ${!email.isRead ? '<span class="w-2 h-2 bg-blue-500 rounded-full flex-shrink-0"></span>' : ''}
                                <div class="${!email.isRead ? 'font-bold' : 'font-semibold'} text-gray-900 dark:text-white text-sm">
                                    ${email.subject || '(No subject)'}
                                </div>
                            </div>
                            <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">
                                ${truncate(email.from, 40)}
                            </div>
                            <div class="flex items-center space-x-2 mt-1">
                                <span class="text-xs text-gray-500 dark:text-gray-400">${formatDate(email.timestamp)}</span>
                                ${email.folder && email.folder !== 'INBOX' ? `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200">üìÅ ${email.folder}</span>` : ''}
                                ${email.attachmentCount > 0 ? `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-primary-100 dark:bg-primary-900 text-primary-800 dark:text-primary-200">üìé ${email.attachmentCount}</span>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Select email and load full detail
        async function selectEmail(filename) {
            selectedEmailFilename = filename;

            try {
                const response = await fetch(`/api/emails/${filename}/full`);
                selectedEmail = await response.json();

                // Automaticky oznaƒçit jako p≈ôeƒçten√Ω
                if (!selectedEmail.isRead) {
                    await markAsRead(filename);
                    selectedEmail.isRead = true;
                }

                renderEmailDetail();
            } catch (error) {
                console.error('Failed to load email detail:', error);
                document.getElementById('emailDetail').innerHTML = `
                    <div class="p-4 text-center text-red-500">
                        Error loading details: ${error.message}
                    </div>
                `;
            }

            // Re-render list to highlight selected
            renderEmailList();
        }

        // Mark email as read
        async function markAsRead(filename) {
            try {
                await fetch(`/api/emails/${filename}/read`, { method: 'POST' });
                // Update local cache
                const email = allEmails.find(e => e.filename === filename);
                if (email) email.isRead = true;
            } catch (error) {
                console.error('Failed to mark as read:', error);
            }
        }

        // Mark email as unread
        async function markAsUnread(filename) {
            try {
                await fetch(`/api/emails/${filename}/unread`, { method: 'POST' });
                // Update local cache
                const email = allEmails.find(e => e.filename === filename);
                if (email) email.isRead = false;
                if (selectedEmail && selectedEmail.filename === filename) {
                    selectedEmail.isRead = false;
                }
                renderEmailDetail();
                renderEmailList();
            } catch (error) {
                console.error('Failed to mark as unread:', error);
            }
        }

        // Render email detail with tabs
        function renderEmailDetail() {
            const detailContainer = document.getElementById('emailDetail');

            if (!selectedEmail) {
                detailContainer.innerHTML = `
                    <div class="text-center">
                        <svg class="w-24 h-24 mx-auto mb-4 text-gray-300 dark:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                        </svg>
                        <p class="text-lg text-gray-500 dark:text-gray-400">Select an email to view details</p>
                    </div>
                `;
                return;
            }

            detailContainer.innerHTML = `
                <div class="flex flex-col h-full w-full">
                    <!-- Email Header -->
                    <div class="border-b border-gray-200 dark:border-gray-700 p-4">
                        <div class="flex items-start justify-between mb-4">
                            <h2 class="text-2xl font-bold text-gray-900 dark:text-white flex-1">${selectedEmail.subject || '(No subject)'}</h2>
                            <div class="flex space-x-2 ml-4">
                                ${selectedEmail.isRead ? `
                                    <button onclick="markAsUnread('${selectedEmail.filename}')" class="px-3 py-1.5 text-sm bg-blue-500 hover:bg-blue-600 text-white rounded transition-colors">
                                        ‚úâÔ∏è Mark as unread
                                    </button>
                                ` : ''}
                                <a href="/api/emails/${selectedEmail.filename}.eml" download class="px-3 py-1.5 text-sm bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded transition-colors">
                                    üíæ Export .eml
                                </a>
                                <div class="relative inline-block">
                                    <select
                                        onchange="if(this.value) { moveEmailToFolder('${selectedEmail.filename}', this.value); this.value = ''; }"
                                        class="px-3 py-1.5 text-sm bg-purple-500 hover:bg-purple-600 text-white rounded transition-colors cursor-pointer appearance-none pr-8"
                                    >
                                        <option value="">üìÅ Move to...</option>
                                        ${(allEmails.reduce((folders, email) => {
                                            if (email.folder && !folders.includes(email.folder) && email.folder !== selectedEmail.folder) {
                                                folders.push(email.folder);
                                            }
                                            return folders;
                                        }, []).sort((a, b) => {
                                            if (a === 'INBOX') return -1;
                                            if (b === 'INBOX') return 1;
                                            return a.localeCompare(b);
                                        })).map(folder => `<option value="${folder}">${folder}</option>`).join('')}
                                    </select>
                                    <svg class="w-4 h-4 text-white absolute right-2 top-2 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </div>
                                <button onclick="deleteEmail('${selectedEmail.filename}')" class="px-3 py-1.5 text-sm bg-red-500 hover:bg-red-600 text-white rounded transition-colors">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div class="flex">
                                <span class="font-semibold text-gray-600 dark:text-gray-400 w-16">From:</span>
                                <span class="text-gray-900 dark:text-white">${selectedEmail.from}</span>
                            </div>
                            <div class="flex">
                                <span class="font-semibold text-gray-600 dark:text-gray-400 w-16">To:</span>
                                <span class="text-gray-900 dark:text-white">${selectedEmail.to}</span>
                            </div>
                            ${selectedEmail.cc ? `
                            <div class="flex">
                                <span class="font-semibold text-gray-600 dark:text-gray-400 w-16">Cc:</span>
                                <span class="text-gray-900 dark:text-white">${selectedEmail.cc}</span>
                            </div>
                            ` : ''}
                            <div class="flex">
                                <span class="font-semibold text-gray-600 dark:text-gray-400 w-16">Date:</span>
                                <span class="text-gray-900 dark:text-white">${selectedEmail.date ? new Date(selectedEmail.date).toLocaleString('en-US') : 'Unknown'}</span>
                            </div>
                            ${selectedEmail.folder ? `
                            <div class="flex">
                                <span class="font-semibold text-gray-600 dark:text-gray-400 w-16">Folder:</span>
                                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${selectedEmail.folder === 'INBOX' ? 'bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200' : 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200'}">üìÅ ${selectedEmail.folder}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Tabs -->
                    <div class="border-b border-gray-200 dark:border-gray-700">
                        <nav class="flex space-x-1 px-6" role="tablist">
                            ${renderTab('html', 'HTML', selectedEmail.htmlBody)}
                            ${renderTab('text', 'Text', selectedEmail.textBody)}
                            ${renderTab('headers', 'Headers', true)}
                            ${renderTab('raw', 'Raw', selectedEmail.rawContent)}
                            ${renderTab('attachments', `Attachments (${selectedEmail.attachments.length})`, selectedEmail.attachments.length > 0)}
                        </nav>
                    </div>

                    <!-- Tab Content -->
                    <div class="flex-1 overflow-y-auto w-full">
                        ${renderTabContent()}
                    </div>
                </div>
            `;
        }

        function renderTab(tabName, label, enabled) {
            const isActive = currentTab === tabName;
            const isDisabled = !enabled;
            return `
                <button
                    onclick="${isDisabled ? '' : `switchTab('${tabName}')`}"
                    class="px-4 py-3 text-sm font-medium border-b-2 transition-colors ${
                        isActive
                            ? 'border-primary-500 text-primary-600 dark:text-primary-400'
                            : isDisabled
                                ? 'border-transparent text-gray-400 dark:text-gray-600 cursor-not-allowed'
                                : 'border-transparent text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white hover:border-gray-300 dark:hover:border-gray-600'
                    }"
                    ${isDisabled ? 'disabled' : ''}
                >
                    ${label}
                </button>
            `;
        }

        function renderTabContent() {
            if (!selectedEmail) return '';

            switch (currentTab) {
                case 'html':
                    if (selectedEmail.htmlBody) {
                        return `<iframe srcdoc="${escapeForAttribute(selectedEmail.htmlBody)}" sandbox="" class="w-full h-full border-0"></iframe>`;
                    } else if (selectedEmail.textBody) {
                        // Fallback: zobrazit textov√Ω obsah jako HTML (escaped)
                        return `<pre class="whitespace-pre-wrap text-sm text-gray-900 dark:text-gray-100 font-mono p-4 w-full h-full">${escapeHtml(selectedEmail.textBody)}</pre>`;
                    } else {
                        return '<div class="text-gray-500 dark:text-gray-400 text-center py-8">No content</div>';
                    }

                case 'text':
                    return selectedEmail.textBody
                        ? `<pre class="whitespace-pre-wrap text-sm text-gray-900 dark:text-gray-100 font-mono p-4 w-full h-full">${escapeHtml(selectedEmail.textBody)}</pre>`
                        : '<div class="text-gray-500 dark:text-gray-400 text-center py-8">No text content</div>';

                case 'headers':
                    return `<div class="p-4 space-y-2 w-full">${Object.entries(selectedEmail.headers).map(([key, value]) => {
                        // Zobrazit hlaviƒçky ƒçitelnƒõ
                        let displayValue;
                        if (typeof value === 'object' && value !== null) {
                            // Pokud je to parsovan√° email hlaviƒçka s text vlastnost√≠ (from, to, cc, atd.)
                            if (value.text) {
                                displayValue = value.text;
                            } else if (value.value !== undefined) {
                                // Pokud m√° value vlastnost (nap≈ô. content-type)
                                if (value.params && Object.keys(value.params).length > 0) {
                                    // Zobrazit value + parametry v ƒçiteln√© formƒõ
                                    const params = Object.entries(value.params).map(([k, v]) => `${k}=${v}`).join('; ');
                                    displayValue = `${value.value}; ${params}`;
                                } else {
                                    displayValue = String(value.value);
                                }
                            } else if (Array.isArray(value)) {
                                // Pokud je to pole, zobrazit jako JSON
                                displayValue = JSON.stringify(value, null, 2);
                            } else {
                                // Jinak zobrazit cel√Ω objekt jako JSON
                                displayValue = JSON.stringify(value, null, 2);
                            }
                        } else {
                            displayValue = String(value);
                        }
                        return `
                        <div class="flex border-b border-gray-200 dark:border-gray-700 pb-2">
                            <span class="font-semibold text-gray-600 dark:text-gray-400 w-48 flex-shrink-0">${escapeHtml(key)}:</span>
                            <span class="text-gray-900 dark:text-white break-all whitespace-pre-wrap font-mono text-sm">${escapeHtml(displayValue)}</span>
                        </div>
                        `;
                    }).join('')}</div>`;

                case 'raw':
                    return `<pre class="text-xs text-gray-900 dark:text-gray-100 font-mono p-4 w-full h-full whitespace-pre-wrap break-all">${escapeHtml(selectedEmail.rawContent)}</pre>`;

                case 'attachments':
                    if (selectedEmail.attachments.length === 0) {
                        return '<div class="text-gray-500 dark:text-gray-400 text-center py-8">No attachments</div>';
                    }
                    return `<div class="p-4 w-full"><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${selectedEmail.attachments.map(att => `
                            <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:shadow-lg transition-shadow">
                                ${att.isImage ? `
                                    <img src="/api/emails/${selectedEmail.filename}/attachments/${att.index}/thumb"
                                         class="w-full h-40 object-cover rounded mb-3"
                                         alt="${escapeHtml(att.filename)}"
                                         onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Crect fill=%22%23ddd%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%22 y=%2250%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22%3EImage%3C/text%3E%3C/svg%3E'">
                                ` : `
                                    <div class="w-full h-40 bg-gray-100 dark:bg-gray-700 rounded mb-3 flex items-center justify-center">
                                        <svg class="w-16 h-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                    </div>
                                `}
                                <div class="text-sm font-semibold text-gray-900 dark:text-white truncate mb-1">${escapeHtml(att.filename)}</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400 mb-3">${formatSize(att.size)} ‚Ä¢ ${att.contentType}</div>
                                <a href="/api/emails/${selectedEmail.filename}/attachments/${att.index}"
                                   download="${escapeHtml(att.filename)}"
                                   class="block w-full text-center px-3 py-2 bg-primary-500 hover:bg-primary-600 text-white text-sm rounded transition-colors">
                                    üíæ Download
                                </a>
                            </div>
                        `).join('')}
                    </div></div>`;

                default:
                    return '';
            }
        }

        function switchTab(tabName) {
            currentTab = tabName;
            renderEmailDetail();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Escape HTML for use in srcdoc attribute (only escape quotes and special chars for attributes)
        function escapeForAttribute(str) {
            return str.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        }

        // Bulk actions
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll').checked;
            document.querySelectorAll('.email-checkbox').forEach(cb => {
                cb.checked = selectAll;
            });
        }

        async function deleteSelected() {
            const selected = Array.from(document.querySelectorAll('.email-checkbox:checked'))
                .map(cb => cb.dataset.filename);

            if (selected.length === 0) {
                alert('No emails selected');
                return;
            }

            if (!confirm(`Are you sure you want to delete ${selected.length} emails?`)) return;

            for (const filename of selected) {
                try {
                    await fetch(`/api/emails/${filename}`, { method: 'DELETE' });
                } catch (error) {
                    console.error('Failed to delete:', filename, error);
                }
            }

            document.getElementById('selectAll').checked = false;
            await loadEmails();
        }

        async function deleteAll() {
            if (!confirm('Are you sure you want to delete ALL emails? This action cannot be undone!')) return;

            try {
                await fetch('/api/emails/all', { method: 'DELETE' });
                selectedEmail = null;
                selectedEmailFilename = null;
                await loadEmails();
            } catch (error) {
                alert('Error deleting: ' + error.message);
            }
        }

        async function deleteEmail(filename) {
            if (!confirm('Are you sure you want to delete this email?')) return;

            try {
                await fetch(`/api/emails/${filename}`, { method: 'DELETE' });
                selectedEmail = null;
                selectedEmailFilename = null;
                await loadEmails();
            } catch (error) {
                alert('Error deleting: ' + error.message);
            }
        }

        // Auto-refresh (only check for new emails, don't reload all)
        function startAutoRefresh() {
            autoRefreshInterval = setInterval(() => {
                loadNewEmails();
            }, 10000); // 10 seconds
        }

        // Import modal management
        let selectedFiles = [];

        function openImportModal() {
            selectedFiles = [];
            document.getElementById('importModal').classList.remove('hidden');
            document.getElementById('selectedFilesList').classList.add('hidden');
            document.getElementById('uploadProgress').classList.add('hidden');
            document.getElementById('importResults').classList.add('hidden');
            document.getElementById('importBtn').disabled = true;
            document.getElementById('emlFileInput').value = '';
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.add('hidden');
            selectedFiles = [];
        }

        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            addFiles(files);
        }

        function addFiles(files) {
            // Filter only .eml files
            const emlFiles = files.filter(file =>
                file.name.endsWith('.eml') || file.type === 'message/rfc822'
            );

            if (emlFiles.length === 0) {
                alert('Please select only .eml files');
                return;
            }

            // Add to selected files (avoid duplicates)
            emlFiles.forEach(file => {
                const exists = selectedFiles.some(f => f.name === file.name && f.size === file.size);
                if (!exists) {
                    selectedFiles.push(file);
                }
            });

            renderFilesList();
            document.getElementById('importBtn').disabled = selectedFiles.length === 0;
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            renderFilesList();
            document.getElementById('importBtn').disabled = selectedFiles.length === 0;
        }

        function renderFilesList() {
            const filesList = document.getElementById('filesList');
            const selectedFilesList = document.getElementById('selectedFilesList');

            if (selectedFiles.length === 0) {
                selectedFilesList.classList.add('hidden');
                return;
            }

            selectedFilesList.classList.remove('hidden');

            filesList.innerHTML = selectedFiles.map((file, index) => `
                <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <div class="flex items-center space-x-3 flex-1 min-w-0">
                        <svg class="w-5 h-5 text-primary-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                        </svg>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900 dark:text-white truncate">${escapeHtml(file.name)}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">${formatSize(file.size)}</p>
                        </div>
                    </div>
                    <button onclick="removeFile(${index})" class="ml-3 text-red-500 hover:text-red-700 dark:hover:text-red-400">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            `).join('');
        }

        async function importFiles() {
            if (selectedFiles.length === 0) return;

            const importBtn = document.getElementById('importBtn');
            const uploadProgress = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('progressBar');
            const progressPercent = document.getElementById('progressPercent');
            const importResults = document.getElementById('importResults');
            const resultsContent = document.getElementById('resultsContent');

            // Disable import button and show progress
            importBtn.disabled = true;
            uploadProgress.classList.remove('hidden');
            importResults.classList.add('hidden');

            try {
                const formData = new FormData();
                selectedFiles.forEach(file => {
                    formData.append('emlFiles', file);
                });

                // Upload with progress
                const xhr = new XMLHttpRequest();

                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        progressBar.style.width = percent + '%';
                        progressPercent.textContent = percent + '%';
                    }
                });

                const response = await new Promise((resolve, reject) => {
                    xhr.onload = () => {
                        if (xhr.status >= 200 && xhr.status < 300) {
                            resolve(JSON.parse(xhr.responseText));
                        } else {
                            reject(new Error('Upload failed'));
                        }
                    };
                    xhr.onerror = () => reject(new Error('Network error'));
                    xhr.open('POST', '/api/emails/import');
                    xhr.send(formData);
                });

                // Show results
                uploadProgress.classList.add('hidden');
                importResults.classList.remove('hidden');

                const successCount = response.imported || 0;
                const failCount = response.failed || 0;

                let resultsHtml = `
                    <div class="p-4 rounded-lg ${successCount > 0 ? 'bg-green-50 dark:bg-green-900/20' : 'bg-red-50 dark:bg-red-900/20'}">
                        <div class="flex items-start space-x-3 mb-3">
                            <svg class="w-6 h-6 ${successCount > 0 ? 'text-green-500' : 'text-red-500'} flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                ${successCount > 0 ? `
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                ` : `
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                `}
                            </svg>
                            <div class="flex-1">
                                <h4 class="text-lg font-semibold ${successCount > 0 ? 'text-green-900 dark:text-green-100' : 'text-red-900 dark:text-red-100'}">
                                    Import ${successCount > 0 ? 'Completed' : 'Failed'}
                                </h4>
                                <p class="text-sm ${successCount > 0 ? 'text-green-700 dark:text-green-300' : 'text-red-700 dark:text-red-300'} mt-1">
                                    Successfully imported: ${successCount} / ${response.total}
                                    ${failCount > 0 ? `<br>Failed: ${failCount}` : ''}
                                </p>
                            </div>
                        </div>
                `;

                // Show errors if any
                if (response.errors && response.errors.length > 0) {
                    resultsHtml += `
                        <div class="mt-3 pt-3 border-t border-red-200 dark:border-red-800">
                            <p class="text-sm font-semibold text-red-900 dark:text-red-100 mb-2">Errors:</p>
                            <ul class="text-xs text-red-700 dark:text-red-300 space-y-1">
                                ${response.errors.map(err => `
                                    <li class="flex items-start space-x-2">
                                        <span class="flex-shrink-0">‚Ä¢</span>
                                        <span><strong>${escapeHtml(err.filename)}:</strong> ${escapeHtml(err.error)}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    `;
                }

                resultsHtml += `</div>`;
                resultsContent.innerHTML = resultsHtml;

                // Reload emails after successful import
                if (successCount > 0) {
                    setTimeout(() => {
                        loadEmails();
                    }, 1000);
                }

                // Reset for next import
                selectedFiles = [];
                renderFilesList();

            } catch (error) {
                console.error('Import failed:', error);
                uploadProgress.classList.add('hidden');
                importResults.classList.remove('hidden');
                resultsContent.innerHTML = `
                    <div class="p-4 bg-red-50 dark:bg-red-900/20 rounded-lg">
                        <div class="flex items-start space-x-3">
                            <svg class="w-6 h-6 text-red-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div>
                                <h4 class="text-lg font-semibold text-red-900 dark:text-red-100">Import Failed</h4>
                                <p class="text-sm text-red-700 dark:text-red-300 mt-1">${escapeHtml(error.message)}</p>
                            </div>
                        </div>
                    </div>
                `;
            } finally {
                importBtn.disabled = false;
                progressBar.style.width = '0%';
                progressPercent.textContent = '0%';
            }
        }

        // Drag & Drop functionality
        const dropZone = document.getElementById('dropZone');

        dropZone.addEventListener('click', () => {
            document.getElementById('emlFileInput').click();
        });

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.add('border-primary-500', 'dark:border-primary-400', 'bg-primary-50', 'dark:bg-primary-900/10');
        });

        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('border-primary-500', 'dark:border-primary-400', 'bg-primary-50', 'dark:bg-primary-900/10');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('border-primary-500', 'dark:border-primary-400', 'bg-primary-50', 'dark:bg-primary-900/10');

            const files = Array.from(e.dataTransfer.files);
            addFiles(files);
        });

        // Close modal on ESC key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeImportModal();
                closeFoldersModal();
            }
        });

        /**
         * Folder Management
         */
        async function openFoldersModal() {
            document.getElementById('foldersModal').classList.remove('hidden');
            await loadFolders();
        }

        function closeFoldersModal() {
            document.getElementById('foldersModal').classList.add('hidden');
            document.getElementById('newFolderName').value = '';
        }

        async function loadFolders() {
            try {
                const response = await fetch('/api/folders');
                const data = await response.json();

                const foldersList = document.getElementById('foldersList');
                const folders = data.folders || [];

                if (folders.length === 0) {
                    foldersList.innerHTML = `
                        <div class="p-4 text-center text-gray-500 dark:text-gray-400">
                            No folders found
                        </div>
                    `;
                    return;
                }

                foldersList.innerHTML = folders.map(folder => `
                    <div class="flex items-center justify-between p-3 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <svg class="w-5 h-5 text-${folder.name === 'INBOX' ? 'blue' : 'purple'}-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
                            </svg>
                            <div>
                                <div class="font-semibold text-gray-900 dark:text-white">${folder.name}</div>
                                <div class="text-sm text-gray-500 dark:text-gray-400">${folder.count} email${folder.count !== 1 ? 's' : ''}</div>
                            </div>
                        </div>
                        ${folder.isDeletable ? `
                            <button onclick="deleteFolder('${folder.name}')" class="px-3 py-1 text-sm bg-red-500 hover:bg-red-600 text-white rounded transition-colors">
                                Delete
                            </button>
                        ` : `
                            <span class="text-xs text-gray-400 dark:text-gray-500">System folder</span>
                        `}
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load folders:', error);
                document.getElementById('foldersList').innerHTML = `
                    <div class="p-4 text-center text-red-500">
                        Error loading folders: ${error.message}
                    </div>
                `;
            }
        }

        async function createFolder() {
            const folderName = document.getElementById('newFolderName').value.trim();

            if (!folderName) {
                alert('Please enter a folder name');
                return;
            }

            try {
                const response = await fetch('/api/folders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: folderName })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to create folder');
                }

                document.getElementById('newFolderName').value = '';
                await loadFolders();
                await loadEmails(); // Refresh email list to update folder filter
            } catch (error) {
                alert('Error creating folder: ' + error.message);
            }
        }

        async function deleteFolder(folderName) {
            if (!confirm(`Are you sure you want to delete the folder "${folderName}"? All emails in this folder will be permanently deleted.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/folders/${encodeURIComponent(folderName)}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete folder');
                }

                await loadFolders();
                await loadEmails(); // Refresh email list
            } catch (error) {
                alert('Error deleting folder: ' + error.message);
            }
        }

        async function moveEmailToFolder(filename, targetFolder) {
            try {
                const response = await fetch(`/api/emails/${filename}/move`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ targetFolder })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to move email');
                }

                await loadEmails(); // Refresh email list

                // Close email detail if it was open
                if (selectedEmailFilename === filename) {
                    selectedEmailFilename = null;
                    selectedEmail = null;
                    renderEmailDetail();
                }
            } catch (error) {
                alert('Error moving email: ' + error.message);
            }
        }

        // Setup infinite scroll
        function setupInfiniteScroll() {
            const emailList = document.getElementById('emailList');
            emailList.addEventListener('scroll', () => {
                // Check if scrolled near bottom (100px threshold)
                const scrollTop = emailList.scrollTop;
                const scrollHeight = emailList.scrollHeight;
                const clientHeight = emailList.clientHeight;

                if (scrollTop + clientHeight >= scrollHeight - 100) {
                    loadMoreEmails();
                }
            });
        }

        // Initialize
        loadEmails();
        startAutoRefresh();
        setupInfiniteScroll();
    </script>
</body>
</html>
